{% extends "base.html" %}
{% block js %}
<!--<script type="text/javascript" src="/site-media/js/bbq.js"></script>-->
<script type="text/javascript" src="/site-media/js/jquery.flot.min.js"></script>
<script type="text/javascript" src="/site-media/js/jquery.flot.pie.min.js"></script>
<script type="text/javascript" src="/site-media/js/jquery.mousewheel.min.js"></script>
<script type="text/javascript">
function getData(dateValues) {
    $.post("{{ entity.id }}", {start: dateValues.min.toString(), end: dateValues.max.toString()}, function(data) {
        console.log(data);
        if (data.length > 0) {
            $("#no-data").toggle(false);
            $("#pie").toggle(true);
            $("#data-table").toggle(true);
            // Chart
            $.plot($("#pie"),data,
                {
                    series: {
                        pie: {
                            show: true,
                            combine: {
                                color: '#999',
                                threshold: {{threshold}}
                            }
                        }
                    },
                    grid: {
                        hoverable: true,
                        clickable: true
                    }
                });
            // Table
            $("#data-table tbody tr").remove();
            $.each(data, function(index, item) {
                $('#data-table > tbody:last').append('<tr><td>' + item.data +'</td><td><a href="/event/{{cross_type}}/' + item.id + '">' + item.label + '</a></td></tr>');
            });
        } else {
            $("#no-data").toggle(true);
            $("#pie").toggle(false);
            $("#data-table").toggle(false);
        }
    }, "json");
}
$(document).ready(function() {
    $("#pie").toggle(false);
    $("#data-table").toggle(false);
    // Slider
    today = new Date();
    slider_opt = {
        bounds:{
            min: new Date(2012, 0, 1),
            max: new Date(today.getFullYear(), today.getMonth(), today.getDate()-1)
        },
        defaultValues:{
            min: new Date(today.getFullYear(), today.getMonth(), today.getDate()-15),
            max: new Date(today.getFullYear(), today.getMonth(), today.getDate()-1)
        }
    };
    var slider = $("#dates");
    slider.dateRangeSlider(slider_opt);
    slider.bind("valuesChanged", function(e, data){
        getData($("#dates").dateRangeSlider("values"));
    });
});
</script>
{% endblock %}
{% block main %}
<div class="page-header">
    <h3>Stats for {{entity}}</h3>
</div>
<div id="no-data" class="alert alert-error">
    No data for that time range.
</div>
<div id="data-display" class="row">
    <div class="span5">
        <table id="data-table" class="table table-hover">
            <thead>
                <tr>
                    <th>Count</th><th>{{cross_type|title}}</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="span6 offset1">
        <div>
            <div id="pie" class="graph"></div>
        </div>
        <div class="span5 rangeslider">
            <div id="dates"></div>
        </div>
    </div>
</div>
{% endblock %}